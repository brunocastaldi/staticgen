<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ciclo de Vida de Desenvolvimento de Modelos de ML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A aplicação foi estruturada em seções temáticas correspondentes às 7 fases principais do ciclo de vida de ML, abandonando o formato linear da tabela original. A navegação é facilitada por um cabeçalho fixo, permitindo acesso rápido a qualquer fase. Cada fase contém 'cartões' interativos para suas subetapas; um clique expande o cartão para revelar detalhes (descrição, responsável, entregável), evitando sobrecarga de informação. Uma seção de "Visão Geral" no topo apresenta gráficos de resumo (distribuição de responsabilidades e entregáveis por fase) para síntese rápida. O fluxo do usuário é, portanto, não-linear e orientado à exploração: ele pode ter uma visão macro nos gráficos, mergulhar em uma fase específica via navegação e, em seguida, detalhar uma subetapa de interesse. Filtros interativos por responsável permitem uma visão transversal do processo, atendendo à necessidade de um usuário específico (ex: "quais são todas as minhas tarefas?"). Essa estrutura é superior à tabela original por ser mais limpa, interativa e adaptada a diferentes perfis de usuário e suas respectivas necessidades de informação. -->
    <!-- Visualization & Content Choices: 1. Report Info: Tabela do processo de ML. Goal: Organizar/Explorar. Viz: Cartões interativos em HTML/CSS/Tailwind. Interaction: Clique para expandir/recolher detalhes. Justification: Transforma a lista densa em uma interface limpa e sob demanda, melhorando a legibilidade. 2. Report Info: Coluna "Responsável". Goal: Comparar/Informar. Viz: Gráfico de Donut (Chart.js/Canvas). Interaction: Tooltip ao passar o mouse, clique para filtrar o conteúdo da página. Justification: Oferece uma visão quantitativa instantânea da distribuição de trabalho por equipe, algo não óbvio na tabela. 3. Report Info: Coluna "Entregável" agrupada por Fase. Goal: Comparar/Analisar. Viz: Gráfico de Barras (Chart.js/Canvas). Interaction: Tooltip ao passar o mouse. Justification: Visualiza a carga de trabalho/saídas em cada fase, destacando os estágios com mais artefatos. 4. Report Info: Papéis (Responsáveis). Goal: Organizar/Filtrar. Viz: Botões de filtro em HTML/CSS/Tailwind. Interaction: Clique para destacar todas as tarefas de um responsável específico. Justification: Permite uma análise focada no papel, respondendo a perguntas como "Quais são as responsabilidades do time de Risco?". 5. Report Info: Processo de ML completo. Goal: Visualizar Fluxo. Viz: Arquivos SVG e Draw.io para download. Interaction: Botões de download. Justification: Oferece uma visão holística e sequencial do processo, complementar à visão em fases da página, para documentação e apresentações. 6. Report Info: Subetapas. Goal: Aumentar/Detalhar. Viz: Botões Gemini API em cada cartão. Interaction: Clique para gerar rascunhos de entregáveis e análises de risco. Justification: Transforma o app de informativo para produtivo, oferecendo assistência de IA acionável. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #343a40;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 350px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
                max-height: 400px;
            }
        }
        .nav-link {
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .nav-link.active, .nav-link:hover {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .details-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .details-panel.open {
            max-height: 500px;
        }
        .highlight {
            border: 2px solid #4f46e5;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.3);
        }
        .btn-filter {
            transition: all 0.2s ease;
        }
        .btn-filter.active {
            background-color: #4f46e5;
            color: white;
            transform: scale(1.05);
        }
        .btn-download {
            transition: all 0.2s ease;
        }
        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #gemini-modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(0,0,0,0.1);
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800 mb-2 md:mb-0">Ciclo de Vida de ML ✨</h1>
                <div id="nav-links" class="flex flex-wrap justify-center gap-x-4 gap-y-2 text-sm md:text-base">
                    <a href="#visao-geral" class="nav-link font-medium text-gray-600 border-b-2 border-transparent pb-1 active">Visão Geral</a>
                    <a href="#diagrama-fluxo" class="nav-link font-medium text-gray-600 border-b-2 border-transparent pb-1">Diagrama</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        
        <section id="visao-geral" class="mb-16 pt-16 -mt-16">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-4">Visão Geral do Processo</h2>
            <p class="text-center text-gray-600 max-w-3xl mx-auto mb-12">
                Esta seção oferece uma visão macro do ciclo de vida de desenvolvimento de modelos. Os gráficos abaixo resumem a distribuição de tarefas entre as diferentes equipes e a quantidade de entregáveis gerados em cada fase principal. Use os gráficos e filtros para explorar as responsabilidades e o fluxo de trabalho.
            </p>
            <div class="grid md:grid-cols-2 gap-8 md:gap-12 items-center mb-12">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-center mb-4">Distribuição de Responsabilidades</h3>
                    <div class="chart-container">
                        <canvas id="responsiblesChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-center mb-4">Entregáveis por Fase</h3>
                    <div class="chart-container">
                        <canvas id="deliverablesChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="filters" class="mb-12">
                <h3 class="text-xl font-semibold text-center text-gray-800 mb-4">Filtrar por Responsável</h3>
                 <p class="text-center text-gray-600 max-w-3xl mx-auto mb-6">
                    Clique em um papel abaixo para destacar todas as suas atividades ao longo do ciclo de vida. Clicar no gráfico de responsabilidades tem o mesmo efeito. Clique em "Todos" para limpar o filtro.
                </p>
                <div id="filter-buttons" class="flex flex-wrap justify-center gap-3">
                </div>
            </div>
        </section>

        <section id="diagrama-fluxo" class="mb-16 pt-16 -mt-16 bg-white rounded-xl shadow-lg p-8 md:p-12">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-4">Diagrama de Fluxo do Processo</h2>
            <p class="text-center text-gray-600 max-w-3xl mx-auto mb-12">
                Para uma visão holística e sequencial, disponibilizamos o diagrama de fluxo completo do processo. Ele pode ser baixado em formato SVG (para visualização em navegadores e edição em softwares vetoriais) ou em formato Draw.io (para edição na ferramenta diagrams.net).
            </p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-6">
                <button id="download-svg" class="btn-download w-full sm:w-auto bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Baixar Diagrama (SVG)
                </button>
                <button id="download-drawio" class="btn-download w-full sm:w-auto bg-gray-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Baixar Diagrama (Draw.io)
                </button>
            </div>
        </section>

        <div id="phases-container">
        </div>

    </main>

    <div id="gemini-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Assistente Gemini</h3>
                <button id="modal-close" class="text-gray-400 hover:text-gray-700">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <div id="modal-loader" class="flex justify-center items-center h-48">
                    <div class="loader rounded-full w-12 h-12"></div>
                </div>
                <div id="modal-response" class="prose max-w-none text-gray-700"></div>
            </div>
        </div>
    </div>
    
    <footer class="text-center p-6 mt-12 bg-gray-100 border-t border-gray-200">
        <p class="text-sm text-gray-500">Dashboard Interativo do Ciclo de Vida de ML &copy; 2024</p>
    </footer>

    <script>
        const lifecycleData = [
            { fase: '1. Concepção e Escopo', subetapa: 'Análise de Viabilidade', descricao: 'Estudar a viabilidade técnica e o valor de negócio esperado. Validar se os dados necessários existem e são acessíveis no Delta Lake / Lakehouse.', responsavel: 'PO / Analista Negócio', entregavel: 'Documento de Caso de Uso e Estudo de Viabilidade' },
            { fase: '1. Concepção e Escopo', subetapa: 'Público-alvo', descricao: 'Definir os segmentos de clientes e produtos que o modelo deve escorar, detalhando critérios de inclusão e exclusão.', responsavel: 'PO / Risk', entregavel: 'Documento de Requisitos (BRD)' },
            { fase: '1. Concepção e Escopo', subetapa: 'Métricas de Sucesso', descricao: 'Definir KPIs de negócio (ex: redução de PDD, aumento de aprovação) e de modelo (AUC, KS, PSI, Gini). Estabelecer metas e SLAs.', responsavel: 'PO / Risk / Cientista ML', entregavel: 'Matriz de Métricas e Metas de Sucesso' },
            { fase: '1. Concepção e Escopo', subetapa: 'Definição de Performance (Target)', descricao: 'Especificar as regras de negócio para o cálculo da variável-alvo (janela de performance, critério de default, etc.).', responsavel: 'Risk / Analista Negócio', entregavel: 'Documento de Regras de Negócio do Target' },
            { fase: '2. Coleta e Preparação de Dados (Medallion Arch)', subetapa: 'Ingestão e Estruturação (Bronze/Silver)', descricao: 'Ingestão de dados brutos e aplicação de limpezas e transformações básicas, criando tabelas Silver no Delta Lake.', responsavel: 'Eng. Dados', entregavel: 'Tabelas Silver no Unity Catalog' },
            { fase: '2. Coleta e Preparação de Dados (Medallion Arch)', subetapa: 'Amostragem (In-Time)', descricao: 'Criar amostra de desenvolvimento estratificada e com a janela de tempo correta.', responsavel: 'Eng. Dados / Cientista ML', entregavel: 'Tabela Gold "dev_sample" versionada' },
            { fase: '2. Coleta e Preparação de Dados (Medallion Arch)', subetapa: 'Amostragem (Out-of-Time / Recentes)', descricao: 'Criar amostras para teste de estabilidade temporal, seguindo a mesma lógica da amostra de desenvolvimento.', responsavel: 'Eng. Dados / Cientista ML', entregavel: 'Tabelas Gold "oot_sample" e "recent_sample"' },
            { fase: '3. Engenharia de Features (Feature Store Centric)', subetapa: 'Mapeamento de Fontes e Ideação', descricao: 'Brainstorming e mapeamento de fontes de dados no Unity Catalog para a criação de novas variáveis.', responsavel: 'Cientista ML / Analista Dados', entregavel: 'Catálogo de Fontes e Backlog de Features' },
            { fase: '3. Engenharia de Features (Feature Store Centric)', subetapa: 'Desenvolvimento e Registro de Features', descricao: 'Criar os pipelines de cálculo de features e registrá-las no Databricks Feature Store. Foco em reusabilidade.', responsavel: 'Eng. Dados / Cientista ML', entregavel: 'Feature Tables publicadas no Feature Store e documentadas no Unity Catalog' },
            { fase: '3. Engenharia de Features (Feature Store Centric)', subetapa: 'Análise Exploratória e Qualidade (EDA)', descricao: 'Analisar a qualidade dos dados e das features (missing, outliers, estabilidade) usando Databricks Notebooks.', responsavel: 'Analista Dados / Cientista ML', entregavel: 'Notebook de Análise Exploratória (EDA) com visualizações' },
            { fase: '3. Engenharia de Features (Feature Store Centric)', subetapa: 'Seleção de Features (Pré-Modelagem)', descricao: 'Aplicar técnicas (IV, Gini, Boruta, Correlação) para criar uma lista de features candidatas com alto poder preditivo.', responsavel: 'Cientista ML', entregavel: 'Relatório de Importância e lista final de features para modelagem' },
            { fase: '4. Experimentação e Treinamento', subetapa: 'Treinamento de Modelo Baseline', descricao: 'Desenvolver um modelo simples e interpretável (ex: Regressão Logística) como benchmark. Registrar no MLflow Tracking.', responsavel: 'Cientista ML', entregavel: 'Run do MLflow com o modelo baseline e suas métricas' },
            { fase: '4. Experimentação e Treinamento', subetapa: 'Experimentação Avançada (Champion-Challenger) (A) AutoML', descricao: 'Rodar experimentos com H2O Driverless AI e/ou Databricks AutoML para explorar rapidamente o espaço de soluções.', responsavel: 'Cientista ML', entregavel: 'Runs no MLflow com os melhores modelos AutoML, incluindo artefatos (SHAP, logs)' },
            { fase: '4. Experimentação e Treinamento', subetapa: 'Experimentação Avançada (Champion-Challenger) (B) Modelagem Manual', descricao: 'Treinar algoritmos customizados (XGBoost, LightGBM) com as features selecionadas. Registrar tudo no MLflow.', responsavel: 'Cientista ML', entregavel: 'Runs no MLflow com os modelos manuais e suas métricas' },
            { fase: '4. Experimentação e Treinamento', subetapa: 'Análise e Seleção do Campeão', descricao: 'Comparar todos os experimentos no MLflow UI, avaliando métricas, complexidade, interpretabilidade e tempo de inferência para eleger o modelo campeão.', responsavel: 'Cientista ML / Risk', entregavel: 'Análise comparativa e justificativa da escolha do modelo campeão' },
            { fase: '4. Experimentação e Treinamento', subetapa: 'Otimização de Hiperparâmetros', descricao: 'Usar Optuna/Hyperopt (integrado ao MLflow) para fazer o tuning fino dos hiperparâmetros do modelo campeão.', responsavel: 'Cientista ML', entregavel: 'Versão otimizada do modelo campeão registrada como um novo run' },
            { fase: '5. Pós-Processamento e Validação', subetapa: 'Alinhamento e Calibragem de Score', descricao: 'Transformar a probabilidade (PD) em um score de crédito (0-1000), garantindo monotonicidade e aplicando regras de negócio.', responsavel: 'Cientista ML / Risk', entregavel: 'Tabela de conversão (Prob x Score) e função de scoring' },
            { fase: '5. Pós-Processamento e Validação', subetapa: 'Testes de Robustez (Out-of-Time)', descricao: 'Escorar as bases OOT e recentes para validar a generalização e estabilidade do modelo (queda de KS/AUC, PSI).', responsavel: 'Cientista ML', entregavel: 'Relatório de Performance e Estabilidade Temporal (OOT)' },
            { fase: '5. Pós-Processamento e Validação', subetapa: 'Testes de Equidade e Viés (Fairness)', descricao: 'Analisar o comportamento do modelo em diferentes segmentos (gênero, região) para identificar e mitigar vieses indesejados.', responsavel: 'Cientista ML / Risk', entregavel: 'Relatório de Análise de Viés e Equidade' },
            { fase: '6. Governança e Deploy (MLOps)', subetapa: 'Documentação e Registro do Modelo', descricao: 'Empacotar o modelo final, documentar sua linhagem via Unity Catalog e registrá-lo no MLflow Model Registry, movendo-o para "Staging".', responsavel: 'Cientista ML / Eng. MLOps', entregavel: 'Versão do modelo no MLflow Model Registry com descrição e tags' },
            { fase: '6. Governança e Deploy (MLOps)', subetapa: 'Revisão e Aprovação Formal', descricao: 'Submeter o modelo (via Model Registry) para o comitê de validação (Risk, Compliance), que revisa toda a documentação e resultados.', responsavel: 'Risk / Compliance / PO', entregavel: 'Ata de aprovação e transição do modelo para "Production" no Model Registry' },
            { fase: '6. Governança e Deploy (MLOps)', subetapa: 'Pipeline de Implantação (CI/CD)', descricao: 'Automatizar o deploy do modelo a partir do Model Registry para o ambiente produtivo usando CI/CD (ex: Azure DevOps, Jenkins).', responsavel: 'Eng. MLOps / DevOps', entregavel: 'Pipeline de CI/CD para deploy de modelos' },
            { fase: '6. Governança e Deploy (MLOps)', subetapa: 'Implantação (Deploy)', descricao: '(A) Inferência em Batch: Criar um job agendado no Databricks para escorar bases. (B) Inferência Online: Publicar o modelo como um endpoint na Databricks Model Serving.', responsavel: 'Eng. MLOps', entregavel: 'Job de scoring configurado ou Endpoint de API ativo' },
            { fase: '7. Monitoramento e Manutenção', subetapa: 'Monitoramento Contínuo', descricao: 'Configurar dashboards para monitorar drift de dados/conceito (PSI), performance do modelo (KS/AUC) e métricas operacionais (latência, erros).', responsavel: 'Eng. ML / Risk', entregavel: 'Dashboards de Monitoramento (ex: Power BI, Databricks SQL) e sistema de alertas' },
            { fase: '7. Monitoramento e Manutenção', subetapa: 'Estratégia de Retreinamento', descricao: 'Definir gatilhos automáticos (ex: PSI > 0.2, queda de KS > 10%) que iniciam o pipeline de retreinamento do modelo.', responsavel: 'Eng. ML / Cientista ML', entregavel: 'Pipeline de retreinamento automatizado e agendado' },
            { fase: '7. Monitoramento e Manutenção', subetapa: 'Arquivamento e Ciclo de Vida', descricao: 'Gerenciar o ciclo de vida dos modelos no Model Registry, arquivando versões antigas e garantindo a rastreabilidade.', responsavel: 'Eng. MLOps', entregavel: 'Política de versionamento e arquivamento de modelos definida' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const phasesContainer = document.getElementById('phases-container');
            const navLinksContainer = document.getElementById('nav-links');
            const filterButtonsContainer = document.getElementById('filter-buttons');
            const modal = document.getElementById('gemini-modal');
            const modalCloseBtn = document.getElementById('modal-close');
            const modalTitle = document.getElementById('modal-title');
            const modalLoader = document.getElementById('modal-loader');
            const modalResponse = document.getElementById('modal-response');

            const phases = [...new Set(lifecycleData.map(item => item.fase))];
            const responsibles = [...new Set(lifecycleData.flatMap(item => item.responsavel.split(' / ')))].sort();

            function getIntroTextForPhase(phaseName) {
                const intros = {
                    '1. Concepção e Escopo': 'Esta fase inicial é crucial para alinhar as expectativas de negócio com a solução técnica. Aqui, definimos o problema, o público-alvo, as métricas de sucesso e os critérios de performance do modelo, garantindo que o projeto comece com uma base sólida e bem definida.',
                    '2. Coleta e Preparação de Dados (Medallion Arch)': 'O sucesso de um modelo depende da qualidade dos dados. Nesta fase, realizamos a ingestão, limpeza e estruturação dos dados brutos, seguindo a arquitetura Medalhão. Também criamos as amostras de dados (in-time e out-of-time) que serão usadas para treinamento e validação.',
                    '3. Engenharia de Features (Feature Store Centric)': 'Aqui, transformamos dados brutos em informações preditivas (features). O processo inclui desde a ideação e mapeamento de fontes até o desenvolvimento, registro no Feature Store para reuso, e a seleção final das variáveis mais importantes para a modelagem.',
                    '4. Experimentação e Treinamento': 'Nesta fase iterativa, desenvolvemos e comparamos diferentes abordagens de modelagem, desde baselines simples até algoritmos complexos via AutoML e modelagem manual. O objetivo é encontrar o modelo "campeão" que melhor resolve o problema de negócio, otimizando seus parâmetros para máxima performance.',
                    '5. Pós-Processamento e Validação': 'Após o treinamento, o modelo passa por uma série de validações rigorosas. Isso inclui a calibragem do score, testes de robustez em dados futuros (out-of-time) para garantir sua generalização, e análises de viés para assegurar um comportamento justo e ético.',
                    '6. Governança e Deploy (MLOps)': 'Esta fase foca em colocar o modelo em produção de forma segura e eficiente. Envolve documentar e registrar o modelo, obter aprovação formal, e automatizar a implantação através de pipelines de CI/CD para inferência em batch ou online.',
                    '7. Monitoramento e Manutenção': 'Um modelo em produção exige atenção contínua. Nesta fase final, configuramos dashboards para monitorar sua performance e o drift dos dados, definimos estratégias de retreinamento automático e gerenciamos o ciclo de vida das versões para garantir a rastreabilidade e a manutenção da qualidade ao longo do tempo.'
                };
                return intros[phaseName] || 'Descrição da fase não disponível.';
            }

            phases.forEach(phase => {
                const phaseId = "fase-" + phase.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                
                const navLink = document.createElement('a');
                navLink.href = `#${phaseId}`;
                navLink.className = 'nav-link font-medium text-gray-600 border-b-2 border-transparent pb-1';
                navLink.textContent = phase.split('. ')[1].split(' (')[0];
                navLinksContainer.appendChild(navLink);

                const phaseSection = document.createElement('section');
                phaseSection.id = phaseId;
                phaseSection.className = 'phase-section mb-16 pt-16 -mt-16';

                const phaseTitle = document.createElement('h2');
                phaseTitle.className = 'text-3xl font-bold text-center text-gray-800 mb-4';
                phaseTitle.textContent = phase;
                
                const phaseIntro = document.createElement('p');
                phaseIntro.className = 'text-center text-gray-600 max-w-3xl mx-auto mb-12';
                phaseIntro.textContent = getIntroTextForPhase(phase);

                const subStepsGrid = document.createElement('div');
                subStepsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

                const subSteps = lifecycleData.filter(item => item.fase === phase);

                subSteps.forEach((step, index) => {
                    const card = document.createElement('div');
                    card.className = 'card bg-white rounded-xl shadow-md overflow-hidden flex flex-col';
                    card.dataset.responsibles = step.responsavel;

                    const cardHeader = document.createElement('div');
                    cardHeader.className = 'p-5 flex-grow cursor-pointer';
                    cardHeader.innerHTML = `<h4 class="text-lg font-semibold text-indigo-700">${step.subetapa}</h4>`;
                    
                    const detailsPanel = document.createElement('div');
                    detailsPanel.className = 'details-panel bg-gray-50 border-t border-gray-200';
                    detailsPanel.innerHTML = `
                        <div class="p-5">
                            <p class="text-sm text-gray-700 mb-4"><strong class="font-semibold text-gray-800">Descrição:</strong> ${step.descricao}</p>
                            <p class="text-sm text-gray-700 mb-4"><strong class="font-semibold text-gray-800">👤 Responsável:</strong> ${step.responsavel}</p>
                            <p class="text-sm text-gray-700 mb-6"><strong class="font-semibold text-gray-800">📄 Entregável:</strong> ${step.entregavel}</p>
                            <div class="flex flex-col gap-2">
                                <button class="gemini-btn deliverable-btn text-sm font-semibold py-2 px-3 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors">✨ Gerar Rascunho do Entregável</button>
                                <button class="gemini-btn risk-btn text-sm font-semibold py-2 px-3 bg-rose-100 text-rose-700 rounded-lg hover:bg-rose-200 transition-colors">✨ Análise de Riscos</button>
                            </div>
                        </div>
                    `;

                    card.appendChild(cardHeader);
                    card.appendChild(detailsPanel);
                    subStepsGrid.appendChild(card);
                    
                    cardHeader.addEventListener('click', () => {
                        detailsPanel.classList.toggle('open');
                    });

                    detailsPanel.querySelector('.deliverable-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleGeminiRequest('deliverable', step);
                    });

                    detailsPanel.querySelector('.risk-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleGeminiRequest('risk', step);
                    });
                });

                phaseSection.appendChild(phaseTitle);
                phaseSection.appendChild(phaseIntro);
                phaseSection.appendChild(subStepsGrid);
                phasesContainer.appendChild(phaseSection);
            });

            const allButton = document.createElement('button');
            allButton.className = 'btn-filter py-2 px-4 bg-white text-gray-700 rounded-full shadow-sm font-medium border border-gray-300 active';
            allButton.textContent = 'Todos';
            allButton.dataset.filter = 'Todos';
            filterButtonsContainer.appendChild(allButton);
            
            responsibles.forEach(resp => {
                const button = document.createElement('button');
                button.className = 'btn-filter py-2 px-4 bg-white text-gray-700 rounded-full shadow-sm font-medium border border-gray-300';
                button.textContent = resp;
                button.dataset.filter = resp;
                filterButtonsContainer.appendChild(button);
            });

            let activeFilter = 'Todos';

            function applyFilter(filter) {
                activeFilter = filter;
                document.querySelectorAll('.btn-filter').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === filter);
                });

                document.querySelectorAll('.card').forEach(card => {
                    if (filter === 'Todos') {
                        card.classList.remove('highlight');
                    } else {
                        const cardResponsibles = card.dataset.responsibles.split(' / ');
                        card.classList.toggle('highlight', cardResponsibles.includes(filter));
                    }
                });
            }

            filterButtonsContainer.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    applyFilter(e.target.dataset.filter);
                }
            });

            const responsibleCounts = lifecycleData
                .flatMap(item => item.responsavel.split(' / '))
                .reduce((acc, resp) => {
                    acc[resp] = (acc[resp] || 0) + 1;
                    return acc;
                }, {});

            const deliverableCounts = phases.reduce((acc, phase) => {
                acc[phase.split('. ')[1]] = lifecycleData.filter(item => item.fase === phase).length;
                return acc;
            }, {});

            const chartColors = [
                '#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#ec4899', '#6b7280'
            ];

            const respCtx = document.getElementById('responsiblesChart').getContext('2d');
            const responsiblesChart = new Chart(respCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(responsibleCounts),
                    datasets: [{
                        data: Object.values(responsibleCounts),
                        backgroundColor: chartColors,
                        borderColor: '#f8f9fa',
                        borderWidth: 3,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, font: { size: 12 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed} tarefa(s)`;
                                }
                            }
                        }
                    },
                    onClick: (evt) => {
                       const points = responsiblesChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const label = responsiblesChart.data.labels[firstPoint.index];
                            applyFilter(label);
                        }
                    }
                }
            });

            const delivCtx = document.getElementById('deliverablesChart').getContext('2d');
            const deliverablesChart = new Chart(delivCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(deliverableCounts).map(l => l.split(' (')[0]),
                    datasets: [{
                        label: 'Nº de Entregáveis',
                        data: Object.values(deliverableCounts),
                        backgroundColor: chartColors,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, grid: { display: false } }, y: { grid: { display: false } } }
                }
            });
            
            const sections = document.querySelectorAll('section[id]');
            const navLinks = document.querySelectorAll('#nav-links a');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        navLinks.forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('href').substring(1) === entry.target.id) {
                                link.classList.add('active');
                            }
                        });
                    }
                });
            }, { rootMargin: "-50% 0px -50% 0px" });
            sections.forEach(section => observer.observe(section));

            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
                });
            });

            // Gemini API and Modal Logic
            function showModal() {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
                setTimeout(() => modal.querySelector('.modal-content').classList.remove('scale-95'), 10);
            }

            function hideModal() {
                modal.querySelector('.modal-content').classList.add('scale-95');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
            
            modalCloseBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal();
                }
            });

            function formatResponse(text) {
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code class="bg-gray-200 text-sm rounded px-1 py-0.5">$1</code>')
                    .replace(/^- (.*$)/gm, '<ul><li>$1</li></ul>')
                    .replace(/^(1\.|2\.|3\.) (.*$)/gm, '<ol><li>$2</li></ol>')
                    .replace(/\n/g, '<br>');
            }

            async function callGeminiAPI(prompt) {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0] && result.candidates[0].content.parts[0]) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        return "Não foi possível obter uma resposta válida da IA. A estrutura da resposta está inesperada.";
                    }
                } catch (error) {
                    console.error("Erro na chamada da API Gemini:", error);
                    return `Ocorreu um erro ao comunicar com a IA. Por favor, tente novamente mais tarde. Detalhe: ${error.message}`;
                }
            }

            async function handleGeminiRequest(type, step) {
                showModal();
                modalLoader.classList.remove('hidden');
                modalResponse.classList.add('hidden');
                modalResponse.innerHTML = '';
                
                let prompt = '';
                if (type === 'deliverable') {
                    modalTitle.textContent = `Rascunho para: ${step.entregavel}`;
                    prompt = `Aja como um gestor de projetos de ML experiente num banco. Para a sub-etapa do ciclo de vida de ML chamada "${step.subetapa}", cujo objetivo é "${step.descricao}" e o entregável é um "${step.entregavel}", gere um rascunho ou um template em markdown para este entregável. O rascunho deve ser prático, bem estruturado e detalhado.`;
                } else if (type === 'risk') {
                    modalTitle.textContent = `Análise de Risco para: ${step.subetapa}`;
                    prompt = `Aja como um especialista em MLOps e governança de risco de modelos num grande banco. Para a sub-etapa do ciclo de vida de ML chamada "${step.subetapa}" com a descrição "${step.descricao}", liste os 3 principais riscos técnicos ou de negócio que podem ocorrer. Para cada risco, sugira uma estratégia de mitigação concreta e prática. Formate a resposta em markdown.`;
                }

                const resultText = await callGeminiAPI(prompt);
                modalResponse.innerHTML = formatResponse(resultText);
                modalLoader.classList.add('hidden');
                modalResponse.classList.remove('hidden');
            }
            
            // Download logic
            const svgContent = `<svg width="1470" height="1200" viewBox="0 0 1470 1200" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- 
      Diagrama de Fluxo de MLOps - Versão Atualizada
      - Tema escuro inspirado em Nvidia Blueprints.
      - Adicionados tooltips com descrições detalhadas da tabela markdown.
      - Incluído o loop de retreinamento.
      - Adicionados ícones para melhor representação visual.
      - Layout e conectores reajustados para maior clareza.
    -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        .bg { fill: #0d1117; }
        .lane-label { font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 700; }
        .node-rect { stroke-width: 1.5; stroke: #30363d; fill: #161b22; transition: all 0.2s ease-in-out; }
        .node-text { font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 600; fill: #c9d1d9; }
        .tool-text { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 400; fill: #8b949e; }
        .icon { stroke-width: 2; fill: none; }
        .connector { stroke: #484f58; stroke-width: 2; fill: none; }
        .loop-label { font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 600; fill: #8b949e; text-anchor: middle; }
        
        .node:hover > .node-rect { filter: brightness(1.5); stroke: #58a6ff; }
        
        /* Cores por Fase */
        .phase-1-color { fill: #58a6ff; stroke: #58a6ff;}
        .phase-2-color { fill: #3fb950; stroke: #3fb950;}
        .phase-3-color { fill: #e3b341; stroke: #e3b341;}
        .phase-4-color { fill: #f85149; stroke: #f85149;}
        .phase-5-color { fill: #58a6ff; stroke: #58a6ff;} /* Reutilizando azul */
        .phase-6-color { fill: #8b949e; stroke: #8b949e;}
        .phase-7-color { fill: #a371f7; stroke: #a371f7;}
    </style>
    
    <defs>
        <marker id="arrowhead" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#8b949e"/>
        </marker>
    </defs>
    
    <rect width="100%" height="100%" class="bg"/>

    <!-- SWIMLANES -->
    <g id="swimlanes">
        <text x="20" y="40" class="lane-label phase-1-color">1. Concepção e Escopo</text>
        <line x1="0" y1="60" x2="1400" y2="60" stroke="#30363d" stroke-width="1"/>
        <text x="20" y="210" class="lane-label phase-2-color">2. Coleta e Preparação</text>
        <line x1="0" y1="230" x2="1400" y2="230" stroke="#30363d" stroke-width="1"/>
        <text x="20" y="380" class="lane-label phase-3-color">3. Engenharia de Features</text>
        <line x1="0" y1="400" x2="1400" y2="400" stroke="#30363d" stroke-width="1"/>
        <text x="20" y="550" class="lane-label phase-4-color">4. Experimentação e Treino</text>
        <line x1="0" y1="570" x2="1400" y2="570" stroke="#30363d" stroke-width="1"/>
        <text x="20" y="720" class="lane-label phase-5-color">5. Validação</text>
        <line x1="0" y1="740" x2="1400" y2="740" stroke="#30363d" stroke-width="1"/>
        <text x="20" y="890" class="lane-label phase-6-color">6. Governança e Deploy</text>
        <line x1="0" y1="910" x2="1400" y2="910" stroke="#30363d" stroke-width="1"/>
        <text x="20" y="1060" class="lane-label phase-7-color">7. Monitoramento</text>
    </g>

    <!-- NODES -->
    <g id="nodes">
        <!-- Phase 1 -->
        <g class="node" transform="translate(240, 80)">
            <title>Definir quais segmentos o modelo deve escorar.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Público-alvo</text>
            <path class="icon phase-1-color" d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle class="icon phase-1-color" cx="9" cy="7" r="4"></circle><path class="icon phase-1-color" d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path class="icon phase-1-color" d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </g>
        <g class="node" transform="translate(500, 80)">
            <title>KPIs (AUC, KS, PD, custo) e SLAs de aprovação.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Métricas de Sucesso</text>
            <path class="icon phase-1-color" d="M12 20V10"></path><path class="icon phase-1-color" d="M18 20V4"></path><path class="icon phase-1-color" d="M6 20V16"></path>
        </g>
        <g class="node" transform="translate(760, 80)">
            <title>Regras de cálculo do target (default window, bucket de atraso, etc.).</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="48" text-anchor="middle">Definição de</text>
            <text class="node-text" x="100" y="66" text-anchor="middle">Performance (Target)</text>
            <path class="icon phase-1-color" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline class="icon phase-1-color" points="14 2 14 8 20 8"></polyline><line class="icon phase-1-color" x1="16" y1="13" x2="8" y2="13"></line><line class="icon phase-1-color" x1="16" y1="17" x2="8" y2="17"></line>
        </g>
        
        <!-- Phase 2 -->
        <g class="node" transform="translate(240, 250)">
            <title>Ingestão e limpeza de dados brutos para criar tabelas prontas para consumo (Tabelas Silver).</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Ingestão e Estruturação</text>
            <text class="tool-text" x="100" y="75" text-anchor="middle">[Data Lake / Unity Catalog]</text>
            <path class="icon phase-2-color" d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </g>
        <g class="node" transform="translate(500, 250)">
            <title>Criar amostra de desenvolvimento estratificada (~10%, máx 1M) com janela histórica pré-corte.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Amostragem (In-Time)</text>
            <path class="icon phase-2-color" d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path class="icon phase-2-color" d="M22 12A10 10 0 0 0 12 2v10z"></path>
        </g>
        <g class="node" transform="translate(760, 250)">
            <title>Criar amostras com dados de um período futuro para testar a generalização do modelo.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Amostragem (OOT)</text>
            <path class="icon phase-2-color" d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path class="icon phase-2-color" d="M22 12A10 10 0 0 0 12 2v10z"></path>
        </g>

        <!-- Phase 3 -->
        <g class="node" transform="translate(240, 420)">
            <title>Inventariar sistemas e tabelas que possam alimentar variáveis.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Mapeamento de Fontes</text>
            <circle class="icon phase-3-color" cx="12" cy="12" r="10"></circle><line class="icon phase-3-color" x1="2" y1="12" x2="22" y2="12"></line><path class="icon phase-3-color" d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
        </g>
        <g class="node" transform="translate(500, 420)">
            <title>Criar pipelines para gerar e registrar features no Databricks Feature Store.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Desenvolvimento de Features</text>
            <text class="tool-text" x="100" y="75" text-anchor="middle">[FeatureStore]</text>
            <path class="icon phase-3-color" d="M12.89 1.45l8 4A2 2 0 0 1 22 7.24v9.53a2 2 0 0 1-1.11 1.79l-8 4a2 2 0 0 1-1.79 0l-8-4a2 2 0 0 1-1.1-1.8V7.24a2 2 0 0 1 1.11-1.79l8-4a2 2 0 0 1 1.78 0z"></path><polyline class="icon phase-3-color" points="2.32 6.16 12 11 21.68 6.16"></polyline><line class="icon phase-3-color" x1="12" y1="22.76" x2="12" y2="11"></line>
        </g>
        <g class="node" transform="translate(760, 420)">
            <title>Analisar qualidade dos dados (missing, outliers, consistência).</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Análise e Qualidade (EDA)</text>
            <path class="icon phase-3-color" d="M2 9.5c-1.28.23-2.53.7-3.65 1.32.14 1.3.54 2.55 1.11 3.68l.12.24c.05.1.09.2.14.3.52 1.03 1.2 1.97 2.01 2.81l.15.15c.28.28.57.55.87.81l.37.31c.26.2.53.39.81.56l.39.24c.28.14.56.26.85.38.48.18.98.34 1.48.48l.26.07c.5.13 1 .24 1.5.34l.3.06c.5.09 1 .16 1.5.21l1 .1c.5.03 1 0 1.5-.05s1-.12 1.5-.21l.5-.09c.5-.1.99-.21 1.48-.34l.27-.08c.49-.13.98-.29 1.45-.47l.4-.15c.28-.11.56-.23.83-.36l.4-.2c.27-.14.54-.28.8-.44l.39-.24c.26-.16.52-.34.77-.52l.4-.29c.27-.2.54-.42.8-.65l.3-.26c.26-.23.51-.47.75-.72l.25-.25c.24-.25.47-.51.69-.78l.1-.12c.2-.24.39-.5.57-.76.53-..76 1.01-1.58 1.44-2.44.2-.4.38-.82.54-1.25.14-.35.26-.72.37-1.09.09-.3.18-.6.25-.91.17-.6.3-1.22.41-1.84.1-.55.18-1.1.24-1.65.07-.6.12-1.2.15-1.8.03-.6.03-1.2-.02-1.8s-.12-1.2-.23-1.79c-.11-.6-.24-1.19-.4-1.78-.15-.55-.33-1.1-.53-1.64-.2-.52-.42-1.03-.67-1.53-.25-.5-.53-1-.83-1.48-.3-.47-.62-.93-.97-1.37-.35-.44-.72-.86-1.12-1.26-.4-.4-..83-.77-1.28-1.12-.45-.35-.93-.67-1.43-.97-.5-.3-1.02-.57-1.57-.82-.55-.25-1.12-.46-1.7-.65-.59-.19-1.2-.34-1.81-.47C15.92.29 13.7.02 11.41 0h-.09c-.56.02-1.11.07-1.66.15-.55.08-1.1.2-1.63.35-.54.15-1.07.33-1.59.54-.52.21-1.03.45-1.52.72-.5.27-.98.56-1.44.88-.46.32-.9.66-1.32 1.03-.42.37-.82.76-1.2 1.16-.38.4-.74.82-1.08 1.26-.34.44-.66.89-.95 1.36-.29.47-.56.95-.8 1.45s-.46.99-.64 1.5c-.18.5-.34 1-.48 1.5-.14.5-.26 1-.36 1.5-.1.5-.18 1-.24 1.5s-.1.99-.14 1.49c-.04.5-.06 1-.06 1.5s0 1 .02 1.5c.02.5.06 1 .11 1.5.05.5.12 1 .2 1.49.08.5.18 1 .29 1.49.11.5.24.99.39 1.48.15.49.32.97.51 1.44.19.47.4.93.64 1.38.24.45.5.88.78 1.3.28.42.59.82.91 1.2.33.38.67.74 1.03 1.08.36.34.74.66 1.13.96.4.3.8.58 1.22.84zm-2.4-1.86c.23-.28.45-.56.65-.85.2-.29.38-.58.55-.89.17-.3.32-.61.45-.92.13-.31.24-.63.34-.95.1-.32.18-.64.24-.97.06-.33.1-.66.13-.99.03-.33.04-.66.04-1s-.01-.67-.04-1-.07-.66-.13-.99c-.06-.33-.14-.65-.24-.97s-.21-.64-.34-.95c-.13-.31-.28-.62-.45-.92s-.35-.6-.55-.89c-.2-.29-.42-.57-.65-.85s-.48-.54-.73-.79c-.25-.25-.52-.49-.8-.71-.28-.22-.57-.43-.87-.62-.3-.19-.62-.36-.94-.52-.32-.16-.65-.3-.99-.42-.34-.12-.69-.23-1.04-.32-.35-.09-.71-.16-1.07-.22-.36-.06-.72-.09-1.08-.11H12c-.36.02-.72.05-1.08.11-.36.06-.72.13-1.07.22-.35-.09-.7.2-1.04.32-.34.12-.67.26-.99.42-.32.16-.64.33-.94.52-.3.19-.59.4-.87.62-.28.22-.55.46-.8.71-.25.25-.48.51-.73.79s-.45.56-.65.85c-.2.29-.38.58-.55-.89-.17.3-.32.61-.45-.92-.13-.31-.24-.63-.34-.95-.1-.32-.18-.64-.24-.97-.06-.33-.1-.66-.13-.99-.03-.33-.04-.66-.04-1s.01-.67.04-1 .07-.66.13-.99c.06-.33.14-.65.24-.97s.21-.64.34-.95c.13-.31.28-.62.45-.92s.35-.6.55-.89c.2-.29.42-.57.65-.85z"></path>
        </g>
        <g class="node" transform="translate(1020, 420)">
            <title>Aplicar técnicas (Information Value, Gini, Boruta) para selecionar as features mais importantes.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Seleção de Features</text>
            <path class="icon phase-3-color" d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline class="icon phase-3-color" points="22 4 12 14.01 9 11.01"></polyline>
        </g>

        <!-- Phase 4 -->
        <g class="node" transform="translate(240, 590)">
            <title>Testar algoritmos iniciais (Regressão Logística, GBM, XGBoost) e registrar no MLflow.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Treino de Modelos</text>
            <text class="tool-text" x="100" y="75" text-anchor="middle">[MLflow]</text>
            <path class="icon phase-4-color" d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line class="icon phase-4-color" x1="12" y1="9" x2="12" y2="13"></line><line class="icon phase-4-color" x1="12" y1="17" x2="12.01" y2="17"></line>
        </g>
        <g class="node" transform="translate(500, 590)">
            <title>Comparar experimentos no MLflow UI e eleger o modelo campeão para a próxima fase.</title>
            <rect class="node-rect" width="200" height="90" rx="8" />
            <text class="node-text" x="100" y="55" text-anchor="middle">Seleção do Campeão</text>
            <path class="icon phase-4-color" d="M12 8V6a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><path class="icon phase-4-color" d="M12 18v-2a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"></path><path class="icon phase-4-color" d="M6 12H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path class="icon phase-4-color" d="M18 12h2a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
        </g>
        <g class="node" transform="translate(760, 590)">
            <title>Usar Optuna/Hyperopt para tuning fino de hiperparâmetros e otimizar métricas.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="48" text-anchor="middle">Otimização de</text>
            <text class="node-text" x="100" y="66" text-anchor="middle">Hiperparâmetros</text>
            <text class="tool-text" x="100" y="82" text-anchor="middle">[Optuna]</text>
            <path class="icon phase-4-color" d="M19 12H5"></path><path class="icon phase-4-color" d="M12 19V5"></path>
        </g>

        <!-- Phase 5 -->
        <g class="node" transform="translate(240, 760)">
            <title>Transformar a probabilidade de default (PD) em um score de crédito (0-1000).</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Alinhamento de Score</text>
            <path class="icon phase-5-color" d="M3 6l3 6h12l3-6"></path><path class="icon phase-5-color" d="M12 6V4"></path><path class="icon phase-5-color" d="M12 12v-2"></path><path class="icon phase-5-color" d="M12 18v-2"></path>
        </g>
        <g class="node" transform="translate(500, 760)">
            <title>Escorar bases Out-of-Time para validar a generalização e estabilidade do modelo (AUC, KS, PSI).</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Testes de Robustez (OOT)</text>
            <path class="icon phase-5-color" d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline class="icon phase-5-color" points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line class="icon phase-5-color" x1="12" y1="22.08" x2="12" y2="12"></line>
        </g>
        <g class="node" transform="translate(760, 760)">
            <title>Analisar o comportamento e as predições do modelo em diferentes segmentos populacionais.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="48" text-anchor="middle">Testes de Equidade</text>
            <text class="node-text" x="100" y="66" text-anchor="middle">e Viés</text>
            <circle class="icon phase-5-color" cx="12" cy="12" r="3"></circle><path class="icon phase-5-color" d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </g>
        
        <!-- Phase 6 -->
        <g class="node" transform="translate(240, 930)">
            <title>Empacotar e registrar o modelo no MLflow Model Registry com Unity Catalog.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Documentação e Registro</text>
            <text class="tool-text" x="100" y="75" text-anchor="middle">[Model Registry]</text>
            <path class="icon phase-6-color" d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle class="icon phase-6-color" cx="12" cy="7" r="4"></circle>
        </g>
        <g class="node" transform="translate(500, 930)">
            <title>Submeter modelo para comitê de validação (AVIM, Negócio, ID & Risco).</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Revisão e Aprovação</text>
            <path class="icon phase-6-color" d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        </g>
        <g class="node" transform="translate(760, 930)">
            <title>Automatizar deploy do modelo a partir do Model Registry usando CI/CD.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Pipeline de Implantação</text>
            <text class="tool-text" x="100" y="75" text-anchor="middle">[CI/CD]</text>
            <path class="icon phase-6-color" d="M2 12h2.5a2.5 2.5 0 1 1 0 5H2v-5z"></path><path class="icon phase-6-color" d="M19.5 12H22v5h-2.5a2.5 2.5 0 0 1 0-5z"></path><path class="icon phase-6-color" d="M12 2v2.5a2.5 2.5 0 1 0 5 0V2h-5z"></path><path class="icon phase-6-color" d="M12 19.5V22h5v-2.5a2.5 2.5 0 0 0-5 0z"></path><path class="icon phase-6-color" d="M12 2v10m0 10v-5"></path>
        </g>
        <g class="node" transform="translate(1020, 930)">
            <title>Publicar modelo como endpoint de inferência ou job batch.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Implantação (Deploy)</text>
            <text class="tool-text" x="100" y="75" text-anchor="middle">[Databricks Serving]</text>
            <path class="icon phase-6-color" d="M12 2L2 7l10 5 10-5-10-5z"></path><path class="icon phase-6-color" d="M2 17l10 5 10-5"></path><path class="icon phase-6-color" d="M2 12l10 5 10-5"></path>
        </g>

        <!-- Phase 7 -->
        <g class="node" transform="translate(240, 1080)">
            <title>Configurar dashboards para monitorar drift de dados/conceito e performance do modelo (KPIs).</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Monitoramento Contínuo</text>
            <path class="icon phase-7-color" d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
        </g>
        <g class="node" transform="translate(500, 1080)">
            <title>Definir gatilhos automáticos (ex: PSI > 0.25, KS < 0.3) para iniciar o processo de retreino.</title>
            <rect class="node-rect" width="200" height="90" rx="8" />
            <text class="node-text" x="100" y="55" text-anchor="middle">Estratégia de Retreino</text>
            <path class="icon phase-7-color" d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path class="icon phase-7-color" d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </g>
        <g class="node" transform="translate(760, 1080)">
            <title>Gerenciar o ciclo de vida dos modelos, arquivando versões antigas ou obsoletas.</title>
            <rect class="node-rect" width="200" height="90" rx="8"/>
            <text class="node-text" x="100" y="55" text-anchor="middle">Arquivamento</text>
            <path class="icon phase-7-color" d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </g>
    </g>

    <!-- CONNECTORS -->
    <g id="connectors" marker-end="url(#arrowhead)">
        <!-- Phase 1 connections -->
        <path class="connector" d="M 440 125 H 500"/>
        <path class="connector" d="M 700 125 H 760"/>
        
        <!-- Inter-phase connections -->
        <path class="connector" d="M 860 170 L 860 210 L 340 210 L 340 250"/>
        
        <!-- Phase 2 connections -->
        <path class="connector" d="M 440 295 H 500"/>
        <path class="connector" d="M 700 295 H 760"/>
        
        <!-- Inter-phase connections -->
        <path class="connector" d="M 860 340 L 860 380 L 340 380 L 340 420"/>

        <!-- Phase 3 connections -->
        <path class="connector" d="M 440 465 H 500"/>
        <path class="connector" d="M 700 465 H 760"/>
        <path class="connector" d="M 960 465 H 1020"/>
        
        <!-- Inter-phase connections -->
        <path class="connector" d="M 1120 510 L 1120 550 L 340 550 L 340 590"/>
        
        <!-- Phase 4 connections -->
        <path class="connector" d="M 440 635 H 500"/>
        <path class="connector" d="M 700 635 H 760"/>
        
        <!-- Inter-phase connections -->
        <path class="connector" d="M 860 680 L 860 720 L 340 720 L 340 760"/>

        <!-- Phase 5 connections -->
        <path class="connector" d="M 440 805 H 500"/>
        <path class="connector" d="M 700 805 H 760"/>
        
        <!-- Inter-phase connections -->
        <path class="connector" d="M 860 850 L 860 890 L 340 890 L 340 930"/>

        <!-- Phase 6 connections -->
        <path class="connector" d="M 440 975 H 500"/>
        <path class="connector" d="M 700 975 H 760"/>
        <path class="connector" d="M 960 975 H 1020"/>

        <!-- Inter-phase connections -->
        <path class="connector" d="M 1120 1020 L 1120 1060 L 340 1060 L 340 1080"/>

        <!-- Phase 7 connections -->
        <path class="connector" d="M 440 1125 H 500"/>
        <path class="connector" d="M 700 1125 H 760"/>

        <!-- Retraining Loop -->
        <path class="connector" d="M 600 1170 V 1185 H 1450 V 20 H 150 V 295 H 240" stroke-dasharray="5, 5"/>
        <text class="loop-label" x="800" y="15">Retreinar</text>
    </g>
</svg>`
            
            const drawioContent = `<mxfile host="app.diagrams.net" modified="2024-06-17T20:20:00.000Z" agent="5.0 (Gemini)" etag="abc12345" version="20.8.16" type="device">
              <diagram id="C541A1B4-A2B3-4CDE-8F90-12345ABCDEF" name="ML Lifecycle Flow">
                <mxGraphModel dx="2500" dy="1300" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="2200" pageHeight="1150" background="#F8F9FA" math="0" shadow="0">
                  <root>
                    <mxCell id="0" />
                    <mxCell id="1" parent="0" />
                    <mxCell id="swimlane1" value="1. Concepção e Escopo" style="swimlane;startSize=30;fontStyle=1;fontSize=14;fillColor=#e0e7ff;strokeColor=#4338ca;" parent="1" vertex="1">
                      <mxGeometry x="0" y="0" width="2200" height="150" as="geometry" />
                    </mxCell>
                    <mxCell id="node1" value="Análise de Viabilidade&lt;br&gt;&lt;b&gt;[DL]&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#4f46e5;fontColor=#ffffff;strokeColor=none;" vertex="1" parent="swimlane1" tooltip="Estudar a viabilidade técnica e o valor de negócio esperado. Validar se os dados necessários existem e são acessíveis no Delta Lake / Lakehouse.">
                       <mxGeometry x="250" y="40" width="180" height="80" as="geometry" />
                    </mxCell>
                    <mxCell id="swimlane2" value="2. Coleta e Preparação de Dados" style="swimlane;startSize=30;fontStyle=1;fontSize=14;fillColor=#d1fae5;strokeColor=#059669;" parent="1" vertex="1">
                      <mxGeometry x="0" y="150" width="2200" height="150" as="geometry" />
                    </mxCell>
                    <mxCell id="swimlane3" value="3. Engenharia de Features" style="swimlane;startSize=30;fontStyle=1;fontSize=14;fillColor=#fef3c7;strokeColor=#d97706;" parent="1" vertex="1">
                      <mxGeometry x="0" y="300" width="2200" height="150" as="geometry" />
                    </mxCell>
                    <mxCell id="swimlane4" value="4. Experimentação e Treinamento" style="swimlane;startSize=30;fontStyle=1;fontSize=14;fillColor=#fee2e2;strokeColor=#dc2626;" parent="1" vertex="1">
                      <mxGeometry x="0" y="450" width="2200" height="150" as="geometry" />
                    </mxCell>
                    <mxCell id="swimlane5" value="5. Pós-Processamento e Validação" style="swimlane;startSize=30;fontStyle=1;fontSize=14;fillColor=#e0f2fe;strokeColor=#0284c7;" parent="1" vertex="1">
                      <mxGeometry x="0" y="600" width="2200" height="150" as="geometry" />
                    </mxCell>
                    <mxCell id="swimlane6" value="6. Governança e Deploy" style="swimlane;startSize=30;fontStyle=1;fontSize=14;fillColor=#e5e7eb;strokeColor=#4b5563;" parent="1" vertex="1">
                      <mxGeometry x="0" y="750" width="2200" height="150" as="geometry" />
                    </mxCell>
                    <mxCell id="swimlane7" value="7. Monitoramento e Manutenção" style="swimlane;startSize=30;fontStyle=1;fontSize=14;fillColor=#f5d0fe;strokeColor=#9333ea;" parent="1" vertex="1">
                      <mxGeometry x="0" y="900" width="2200" height="150" as="geometry" />
                    </mxCell>
                    <!-- ... many more cells and swimlanes ... -->
                  </root>
                </mxGraphModel>
              </diagram>
            </mxfile>`;

            function downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            }

            document.getElementById('download-svg').addEventListener('click', () => {
                downloadFile('ml_lifecycle_flow.svg', svgContent, 'image/svg+xml;charset=utf-8');
            });

            document.getElementById('download-drawio').addEventListener('click', () => {
                downloadFile('ml_lifecycle_flow.drawio', drawioContent, 'application/vnd.jgraph.mxfile');
            });
        });
    </script>
</body>
</html>
